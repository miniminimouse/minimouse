%let all_vars = REFR_LTV SATO_INT LOAN_PURP_REFINANCE MOB_Term_Ratio Lag12_Unemp_SA
PchgO_MA3_Home_Sales BAL_DEF_ADJ PchgO_Unemp_15_Pls_W
Lag6_PChg12_HPI_P_On pre2007dummy;

data train_data;
    set lgd_stage_all_wf;
    model_lgd = lgd_36m;
run;

data score_oot;
    set oot_final_data;
    model_lgd = .;
run;

data combined;
    set train_data (in=intrain) score_oot (in=inoot);
    if intrain then flag = 'TRAIN';
    else flag = 'OOT';
run;

proc qlim data=combined;
    model model_lgd = &all_vars;
    endogenous model_lgd ~ censored(lb=0 ub=1);
    output out=tobit_results predicted marginal;
run;

proc lifereg data=combined;
    model model_lgd = &all_vars / distribution=normal;
    output out=lifereg_results predicted=pred_lgd;
run;

proc means data=tobit_results (where=(flag='TRAIN'));
    var lgd_36m P_model_lgd M_model_lgd;
run;

proc sgplot data=tobit_results (where=(flag='TRAIN'));
    scatter x=lgd_36m y=P_model_lgd;
    refline 0 / axis=x;
    refline 0 / axis=y;
    lineparm x=0 y=0 slope=1 / lineattrs=(color=gray pattern=dash);
run;

data residuals_train;
    set tobit_results (where=(flag='TRAIN'));
    residual = lgd_36m - P_model_lgd;
    abs_residual = abs(residual);
run;

proc sgplot data=residuals_train;
    scatter x=P_model_lgd y=residual;
    refline 0 / axis=y;
run;

proc sql;
    create table metrics_train as
    select
        mean(residual) as mean_residual,
        std(residual) as std_residual,
        mean(abs_residual) as mae,
        sqrt(mean(residual**2)) as rmse
    from residuals_train;
quit;

proc print data=metrics_train;
run;

proc means data=tobit_results (where=(flag='OOT'));
    var lgd_36m P_model_lgd M_model_lgd;
run;

proc sgplot data=tobit_results (where=(flag='OOT'));
    scatter x=lgd_36m y=P_model_lgd;
    refline 0 / axis=x;
    refline 0 / axis=y;
    lineparm x=0 y=0 slope=1 / lineattrs=(color=gray pattern=dash);
run;

data residuals_oot;
    set tobit_results (where=(flag='OOT'));
    residual = lgd_36m - P_model_lgd;
    abs_residual = abs(residual);
run;

proc sgplot data=residuals_oot;
    scatter x=P_model_lgd y=residual;
    refline 0 / axis=y;
run;

proc sql;
    create table metrics_oot as
    select
        mean(residual) as mean_residual,
        std(residual) as std_residual,
        mean(abs_residual) as mae,
        sqrt(mean(residual**2)) as rmse
    from residuals_oot;
quit;

proc print data=metrics_oot;
run;

proc reg data=train_data;
    model lgd_36m = &all_vars / selection=stepwise slentry=0.05 slstay=0.05;
run;

proc corr data=train_data;
    var &all_vars;
run;