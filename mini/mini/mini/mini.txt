/* lgd_censored.sas - comprehensive lgd modeling framework */
/* fits tobit, censored gamma, and beta regression models */

%macro lgd_censored(
      train= ,          
      oot=   ,          
      depvar= ,         
      indep=  ,         
      datevar=def_date, 
      models=TOBIT CG BR,     
      outbase=lgd_out   
   );

   %let eps = 1e-6;     

   /* count variables and clean up the list */
   %let var_count = %sysfunc(countw(&indep));
   %put Processing &var_count predictor variables;

   /* basic data stacking and prep */
   data _combined;
      length sample $5;
      set &train(in=a) &oot(in=b);
      
      if a then sample='TRAIN';
      else if b then sample='OOT';
      
      /* remove missing or out of bounds observations */
      if missing(&depvar) then delete;
      if &depvar < 0 or &depvar > 1 then delete;
      
      /* check for missing predictors */
      if nmiss(of &indep) > 0 then delete;
   run;

   /* quick data summary */
   proc sql noprint;
      select count(*) into :total_obs from _combined;
      select count(*) into :train_obs from _combined where sample='TRAIN';
      select count(*) into :oot_obs from _combined where sample='OOT';
   quit;

   %put Dataset summary - Total: &total_obs, Train: &train_obs, OOT: &oot_obs;

   /* check multicollinearity with vif values - training data only */
   proc reg data=_combined(where=(sample='TRAIN'));
      model &depvar = &indep / vif;
      ods output ParameterEstimates=vif_results;
   run;
   quit;

   /* show vif results if dataset exists */
   %if %sysfunc(exist(vif_results)) %then %do;
      proc print data=vif_results noobs;
         title "VIF Analysis - Multicollinearity Check";
         var Variable Estimate StdErr tValue Probt VarianceInflation;
         where Variable ne 'Intercept';
         format Estimate StdErr 8.4 tValue 8.2 Probt 8.4 VarianceInflation 8.2;
      run;

      /* flag high vif variables */
      data _null_;
         set vif_results;
         where Variable ne 'Intercept' and VarianceInflation > 5;
         if _n_ = 1 then put "WARNING: Variables with VIF > 5 detected:";
         put Variable "VIF=" VarianceInflation 8.2;
      run;
   %end;

   /* initialize the final output datasets */
   data &outbase._pred;
      length sample $5 model $10;
      delete;
   run;
   
   data &outbase._metrics;
      length model $10 sample $5;
      delete;
   run;
   
   data &outbase._compare;
      length model $10;
      delete;
   run;

   /* loop through each model */
   %let nmodels = %sysfunc(countw(&models));
   %do i = 1 %to &nmodels;
      %let model = %upcase(%scan(&models,&i));
      %put Running &model model...;

      /* prep data specific to each model */
      data work_data;
         set _combined;
         
         %if &model = BR %then %do;
            /* beta regression needs open interval (0,1) */
            if &depvar = 0 then &depvar = &eps;
            else if &depvar = 1 then &depvar = 1-&eps;
         %end;
      run;

      /* run the appropriate model */
      %if &model = TOBIT %then %do;
         /* tobit model using proc qlim */
         proc qlim data=work_data;
            model &depvar = &indep;
            endogenous &depvar ~ censored(lb=0 ub=1);
            output out=pred_out predicted marginal;
         run;
         
         /* create predictions dataset */
         data pred_&model;
            set pred_out;
            model = "&model";
            pred_lgd = p_&depvar;
            keep sample &datevar &depvar pred_lgd model;
         run;
      %end;

      %else %if &model = CG %then %do;
         /* censored gamma model */
         proc nlmixed data=work_data tech=newrap qpoints=1 maxiter=200;
            parms beta0=0;
            %do j=1 %to &var_count;
               parms b&j=0;
            %end;
            parms logalpha=0;

            /* build linear predictor */
            eta = beta0;
            %do j=1 %to &var_count;
               %let thisvar = %scan(&indep,&j);
               eta = eta + b&j * &thisvar;
            %end;
            
            mu = exp(eta);
            alpha = exp(logalpha);
            scale = mu / alpha;

            /* censored gamma log-likelihood */
            if &depvar <= &eps then 
               ll = log(cdf('gamma', &eps, alpha, scale));
            else if &depvar >= 1-&eps then 
               ll = log(1 - cdf('gamma', 1-&eps, alpha, scale));
            else 
               ll = log(pdf('gamma', &depvar, alpha, scale));

            model &depvar ~ general(ll);
            predict mu out=nlmix_out(rename=(pred=pred_lgd));
         run;
         
         data pred_&model;
            set nlmix_out;
            model = "&model";
            keep sample &datevar &depvar pred_lgd model;
         run;
      %end;

      %else %if &model = BR %then %do;
         /* beta regression model */
         proc nlmixed data=work_data tech=newrap qpoints=1 maxiter=200;
            parms beta0=0;
            %do j=1 %to &var_count;
               parms b&j=0;
            %end;
            parms logphi=0;

            /* linear predictor */
            eta = beta0;
            %do j=1 %to &var_count;
               %let thisvar = %scan(&indep,&j);
               eta = eta + b&j * &thisvar;
            %end;
            
            mu = exp(eta) / (1 + exp(eta));
            phi = exp(logphi);

            /* beta distribution log-likelihood */
            ll = lgamma(phi) - lgamma(mu*phi) - lgamma((1-mu)*phi) +
                 (mu*phi-1)*log(&depvar) + ((1-mu)*phi-1)*log(1-&depvar);

            model &depvar ~ general(ll);
            predict mu out=nlmix_out(rename=(pred=pred_lgd));
         run;
         
         data pred_&model;
            set nlmix_out;
            model = "&model";
            keep sample &datevar &depvar pred_lgd model;
         run;
      %end;

      /* add residuals and bounds check */
      data pred_&model;
         set pred_&model;
         
         residual = &depvar - pred_lgd;
         abs_residual = abs(residual);
         
         /* make sure predictions stay in bounds */
         if pred_lgd < 0 then pred_lgd = 0;
         if pred_lgd > 1 then pred_lgd = 1;
      run;

      /* calculate metrics using sql to avoid variable issues */
      proc sql;
         create table metrics_&model as
         select 
            "&model" as model,
            sample,
            count(*) as n_obs,
            mean(residual) as bias format=8.4,
            std(residual) as rmse format=8.4,
            mean(abs_residual) as mae format=8.4,
            corr(&depvar, pred_lgd) as correlation format=8.4
         from pred_&model
         group by sample;
      quit;

      /* date level aggregation with sample info */
      proc sql;
         create table avg_&model as
         select 
            "&model" as model,
            &datevar,
            sample,
            mean(&depvar) as actual_lgd format=8.4,
            mean(pred_lgd) as pred_lgd format=8.4,
            count(*) as n_obs
         from pred_&model
         where &datevar is not missing
         group by &datevar, sample;
      quit;

      proc append base=&outbase._pred data=pred_&model force; run;
      proc append base=&outbase._metrics data=metrics_&model force; run;
      proc append base=&outbase._compare data=avg_&model force; run;

   %end;

   /* create combined backtesting plot like your example */
   /* first reshape the data for plotting */
   data plot_data;
      set &outbase._compare;
      
      /* create separate series for actual and predicted by sample */
      length series_name $50;
      
      /* actual values */
      value = actual_lgd;
      series_name = catx(' ', 'Actual', sample);
      output;
      
      /* predicted values */
      value = pred_lgd;
      series_name = catx(' ', 'Predicted', sample);
      output;
      
      keep &datevar value series_name model sample;
   run;

   /* create the combined plot for each model */
   %do i = 1 %to &nmodels;
      %let model = %upcase(%scan(&models,&i));
      
      proc sgplot data=plot_data(where=(model="&model"));
         series x=&datevar y=value / group=series_name
                lineattrs=(thickness=2)
                markers markerattrs=(size=4);
         xaxis label="Default Date" valueattrs=(size=10pt);
         yaxis label="LGD Level" valueattrs=(size=10pt) min=0 max=1;
         keylegend / position=topright across=1;
         title "&model Model - Train vs OOT Performance" height=14pt;
      run;
   %end;

   /* show final results */
   proc print data=&outbase._metrics noobs;
      title "Model Performance Comparison";
      var model sample n_obs bias rmse mae correlation;
   run;

   /* cleanup temp datasets */
   proc datasets lib=work nolist;
      delete _combined work_data pred_out nlmix_out pred_: metrics_: avg_: 
             plot_data vif_results;
   quit;

%mend lgd_censored;

/* usage example */
%let all_vars = REFR_LTV SATO_INT LOAN_PURP_REFINANCE MOB_Term_Ratio
                Lag12_Unemp_SA PchgO_MA3_Home_Sales BAL_DEF_ADJ
                PchgO_Unemp_15_Pls_Wk Lag6_PChg12_HPI_P_Only pre2007dummy;

%lgd_censored(
   train=lgd_training_data,
   oot=lgd_oot_data, 
   depvar=lgd_36M,
   indep=&all_vars,
   datevar=def_date,
   models=TOBIT CG BR,
   outbase=lgd_results
);
